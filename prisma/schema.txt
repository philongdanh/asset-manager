generator client {
  provider = "prisma-client-js"
  output   = "../generated/client"
}

datasource db {
  provider = "postgresql"
}

// ========================================================
// ENUMS
// ========================================================

enum AssetCondition {
  DAMAGED
  EXCELLENT
  FAIR
  GOOD
  NEW
  POOR
  UNUSABLE
  USED
}

enum AssetDisposalStatus {
  APPROVED
  CANCELLED
  COMPLETED
  PENDING
  REJECTED
}

enum AssetDisposalType {
  DAMAGED_BEYOND_REPAIR
  DISCARD
  DONATION
  LOST
  SALE
}

enum AssetItemStatus {
  AVAILABLE
  DISPOSED
  IN_USE
  LOST
  UNDER_MAINTENANCE
  UNDER_REPAIR
}

enum AssetTransferStatus {
  APPROVED
  CANCELLED
  COMPLETED
  IN_TRANSIT
  PENDING
  REJECTED
}

enum MaintenanceStatus {
  CANCELLED
  COMPLETED
  IN_PROGRESS
  PENDING
}

enum MaintenanceType {
  CORRECTIVE
  PREVENTIVE
}

enum PurchaseOrderStatus {
  APPROVED
  CANCELLED
  DRAFT
  ORDERED
  RECEIVED
}

enum TenantStatus {
  ACTIVE
  INACTIVE
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

// ========================================================
// CORE MODELS
// ========================================================

model Tenant {
  id      String       @id @default(uuid())
  name    String
  status  TenantStatus @default(ACTIVE)
  code    String?      @unique
  phone   String?
  email   String?
  address String?

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  departments          Department[]
  users                User[]
  assetCategories      AssetCategory[]
  assetTemplates       AssetTemplate[]
  assetItems           AssetItem[]
  inventoryItems       InventoryItem[]
  suppliers            Supplier[]
  purchaseOrders       PurchaseOrder[]
  auditLogs            AuditLog[]
  maintenanceSchedules MaintenanceSchedule[]
  assetTransfers       AssetTransfer[]
  assetDisposals       AssetDisposal[]
  budgetPlans          BudgetPlan[]

  @@map("tenants")
}

model Department {
  id       String  @id @default(uuid())
  tenantId String  @map("tenant_id")
  name     String
  parentId String? @map("parent_id")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  tenant   Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parent   Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [id], onDelete: Restrict)
  children Department[] @relation("DepartmentHierarchy")

  assetItems    AssetItem[]     @relation("AssetItemCurrentDepartment")
  users         User[]
  budgetPlans   BudgetPlan[]
  transfersFrom AssetTransfer[] @relation("TransferFromDepartment")
  transfersTo   AssetTransfer[] @relation("TransferToDepartment")

  @@unique([tenantId, name])
  @@map("departments")
}

model User {
  id           String     @id @default(uuid())
  tenantId     String?    @map("tenant_id")
  departmentId String?    @map("department_id")
  username     String
  password     String
  email        String     @unique
  isRoot       Boolean    @default(false) @map("is_root")
  status       UserStatus @default(ACTIVE)
  avatarUrl    String?    @map("avatar_url")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  tenant     Tenant?     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  department Department? @relation(fields: [departmentId], references: [id])

  createdAssetItems AssetItem[]           @relation("AssetItemCreator")
  currentAssetItems AssetItem[]           @relation("AssetItemHolder")
  maintenances      MaintenanceSchedule[] @relation("MaintenancePerformer")
  auditLogs         AuditLog[]
  transfersFrom     AssetTransfer[]       @relation("TransferFromUser")
  transfersTo       AssetTransfer[]       @relation("TransferToUser")
  approvedDisposals AssetDisposal[]       @relation("AssetDisposalApprover")

  @@unique([tenantId, username])
  @@map("users")
}

// ========================================================
// ASSET MANAGEMENT
// ========================================================

model AssetCategory {
  id       String  @id @default(uuid())
  tenantId String  @map("tenant_id")
  name     String
  code     String
  parentId String? @map("parent_id")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  tenant   Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parent   AssetCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Restrict)
  children AssetCategory[] @relation("CategoryHierarchy")

  assetTemplates AssetTemplate[]
  inventoryItems InventoryItem[]

  @@unique([tenantId, code])
  @@map("asset_categories")
}

model AssetTemplate {
  id             String  @id @default(uuid())
  tenantId       String  @map("tenant_id")
  categoryId     String  @map("category_id")
  code           String
  name           String
  model          String?
  manufacturer   String?
  description    String?
  specifications String?

  defaultPurchasePrice  Decimal? @map("default_purchase_price")
  defaultWarrantyMonths Int?     @map("default_warranty_months")

  trackQuantity Boolean @default(false) @map("track_quantity")
  minStock      Int?    @map("min_stock")
  maxStock      Int?    @map("max_stock")

  requireSerial Boolean @default(false) @map("require_serial")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  tenant   Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  category AssetCategory @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  assetItems AssetItem[]

  @@unique([tenantId, code])
  @@map("asset_templates")
}

model AssetItem {
  id         String @id @default(uuid())
  tenantId   String @map("tenant_id")
  templateId String @map("template_id")
  code       String

  serialNumber  String?   @map("serial_number")
  purchaseDate  DateTime? @map("purchase_date")
  purchasePrice Decimal?  @map("purchase_price")
  currentValue  Decimal?  @map("current_value")

  status    AssetItemStatus @default(AVAILABLE)
  condition AssetCondition? @default(GOOD)
  location  String?

  warrantyStartDate DateTime? @map("warranty_start_date")
  warrantyEndDate   DateTime? @map("warranty_end_date")

  createdByUserId     String? @map("created_by_user_id")
  currentDepartmentId String? @map("current_department_id")
  currentUserId       String? @map("current_user_id")
  supplierId          String? @map("supplier_id")
  purchaseOrderId     String? @map("purchase_order_id")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  tenant            Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  template          AssetTemplate  @relation(fields: [templateId], references: [id], onDelete: Restrict)
  creator           User?          @relation("AssetItemCreator", fields: [createdByUserId], references: [id])
  currentDepartment Department?    @relation("AssetItemCurrentDepartment", fields: [currentDepartmentId], references: [id])
  currentUser       User?          @relation("AssetItemHolder", fields: [currentUserId], references: [id])
  supplier          Supplier?      @relation(fields: [supplierId], references: [id])
  purchaseOrder     PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id])

  maintenances MaintenanceSchedule[]
  transfers    AssetTransfer[]
  disposals    AssetDisposal[]

  @@unique([tenantId, code])
  @@unique([tenantId, serialNumber])
  @@map("asset_items")
}

model MaintenanceSchedule {
  id                String            @id @default(uuid())
  tenantId          String            @map("tenant_id")
  assetItemId       String            @map("asset_item_id")
  date              DateTime
  type              MaintenanceType   @default(PREVENTIVE)
  status            MaintenanceStatus @default(PENDING)
  description       String?
  estimatedCost     Decimal?          @map("estimated_cost") @db.Decimal(19, 4)
  actualCost        Decimal?          @map("actual_cost") @db.Decimal(19, 4)
  performedByUserId String?           @map("performed_by_user_id")
  result            String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  assetItem AssetItem @relation(fields: [assetItemId], references: [id], onDelete: Cascade)
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  performer User?     @relation("MaintenancePerformer", fields: [performedByUserId], references: [id])

  @@map("maintenance_schedules")
}

model AssetTransfer {
  id               String              @id @default(uuid())
  tenantId         String              @map("tenant_id")
  assetItemId      String              @map("asset_item_id")
  transferDate     DateTime            @map("transfer_date")
  fromDepartmentId String?             @map("from_department_id")
  toDepartmentId   String?             @map("to_department_id")
  fromUserId       String?             @map("from_user_id")
  toUserId         String?             @map("to_user_id")
  reason           String?
  status           AssetTransferStatus @default(PENDING)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  assetItem      AssetItem   @relation(fields: [assetItemId], references: [id], onDelete: Cascade)
  tenant         Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  fromDepartment Department? @relation("TransferFromDepartment", fields: [fromDepartmentId], references: [id])
  toDepartment   Department? @relation("TransferToDepartment", fields: [toDepartmentId], references: [id])
  fromUser       User?       @relation("TransferFromUser", fields: [fromUserId], references: [id])
  toUser         User?       @relation("TransferToUser", fields: [toUserId], references: [id])

  @@map("asset_transfers")
}

model AssetDisposal {
  id               String              @id @default(uuid())
  assetItemId      String              @map("asset_item_id")
  tenantId         String              @map("tenant_id")
  disposalDate     DateTime            @map("disposal_date")
  disposalType     AssetDisposalType   @map("disposal_type")
  disposalValue    Decimal             @map("disposal_value") @db.Decimal(19, 4)
  reason           String?
  approvedByUserId String?             @map("approved_by_user_id")
  status           AssetDisposalStatus @default(PENDING)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  assetItem AssetItem @relation(fields: [assetItemId], references: [id], onDelete: Cascade)
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  approver  User?     @relation("AssetDisposalApprover", fields: [approvedByUserId], references: [id])

  @@map("asset_disposals")
}

// ========================================================
// INVENTORY MANAGEMENT
// ========================================================

model InventoryItem {
  id          String  @id @default(uuid())
  tenantId    String  @map("tenant_id")
  categoryId  String? @map("category_id")
  supplierId  String? @map("supplier_id")
  sku         String  @map("sku")
  name        String
  description String?
  unit        String  @default("piece")

  currentStock Int  @default(0) @map("current_stock")
  minStock     Int? @map("min_stock")
  maxStock     Int? @map("max_stock")

  unitCost   Decimal @map("unit_cost") @db.Decimal(19, 4)
  totalValue Decimal @default(0) @map("total_value") @db.Decimal(19, 4)

  storageLocation String? @map("storage_location")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  tenant   Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  category AssetCategory? @relation(fields: [categoryId], references: [id])
  supplier Supplier?      @relation(fields: [supplierId], references: [id])

  @@unique([tenantId, sku])
  @@map("inventory_items")
}

// ========================================================
// SUPPLIER & PROCUREMENT
// ========================================================

model Supplier {
  id       String  @id @default(uuid())
  tenantId String  @map("tenant_id")
  code     String
  name     String
  phone    String?
  email    String?
  address  String?

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assetItems     AssetItem[]
  inventoryItems InventoryItem[]
  purchaseOrders PurchaseOrder[]

  @@unique([tenantId, code])
  @@map("suppliers")
}

model PurchaseOrder {
  id          String              @id @default(uuid())
  tenantId    String              @map("tenant_id")
  supplierId  String              @map("supplier_id")
  poNumber    String              @map("po_number")
  orderDate   DateTime            @map("order_date")
  totalAmount Decimal             @map("total_amount") @db.Decimal(19, 4)
  status      PurchaseOrderStatus @default(DRAFT)
  notes       String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  supplier Supplier @relation(fields: [supplierId], references: [id])

  assetItems AssetItem[]

  @@unique([tenantId, poNumber])
  @@map("purchase_orders")
}

// ========================================================
// BUDGET MANAGEMENT
// ========================================================

model BudgetPlan {
  id              String  @id @default(uuid())
  tenantId        String  @map("tenant_id")
  departmentId    String  @map("department_id")
  fiscalYear      Int     @map("fiscal_year")
  allocatedAmount Decimal @map("allocated_amount") @db.Decimal(19, 4)
  spentAmount     Decimal @default(0) @map("spent_amount") @db.Decimal(19, 4)
  notes           String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant     Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  department Department @relation(fields: [departmentId], references: [id])

  @@map("budget_plans")
}

// ========================================================
// AUDIT LOGS
// ========================================================

model AuditLog {
  id         String   @id @default(uuid())
  tenantId   String   @map("tenant_id")
  userId     String   @map("user_id")
  action     String
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  oldValue   String?  @map("old_value")
  newValue   String?  @map("new_value")
  actionTime DateTime @default(now()) @map("action_time")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}
